<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Mazer Admin Dashboard</title>

    <link rel="stylesheet" href="assets/css/bootstrap.css" />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="assets/vendors/iconly/bold.css" />
    <link rel="stylesheet" href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="assets/vendors/bootstrap-icons/bootstrap-icons.css" />
    <link rel="stylesheet" href="assets/css/app.css" />
    <link rel="shortcut icon" href="assets/images/favicon.svg" type="image/x-icon" />
</head>
<body style="background-color: #eee" onload="validateToken()">
    <section style="background-color: #eee">
        <div class="container py-5">
            <div class="row">
                <div class="col">
                    <nav aria-label="breadcrumb" class="bg-body-tertiary rounded-3 p-3 mb-4">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item active" aria-current="page">Profile</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <div class="row" style="display: flex; flex-direction: column; justify-content: center;">
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-body text-center">
                            <img
                                src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3.webp"
                                alt="avatar"
                                class="rounded-circle img-fluid"
                                style="width: 150px"
                            />
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <!-- Full Name -->
                            <div class="row">
                                <div class="col-sm-3">
                                    <p class="mb-0">Full Name</p>
                                </div>
                                <div class="col-sm-9 d-flex align-items-center">
                                    <p class="text-muted mb-0" id="name" onclick="openEdit('name')">Johnatan Smith</p>
                                    <i class="bi bi-pencil ms-2" onclick="openEdit('name')"></i>
                                </div>
                            </div>
                            <hr />

                            <!-- Email -->
                            <div class="row">
                                <div class="col-sm-3">
                                    <p class="mb-0">Email</p>
                                </div>
                                <div class="col-sm-9 d-flex align-items-center">
                                    <p class="text-muted mb-0" id="email">example@example.com</p>
                                    <i class="bi bi-pencil ms-2" onclick="openEdit('email')"></i>
                                </div>
                            </div>
                            <hr />

                            <!-- Phone -->
                            <div class="row">
                                <div class="col-sm-3">
                                    <p class="mb-0">Phone</p>
                                </div>
                                <div class="col-sm-9 d-flex align-items-center">
                                    <p class="text-muted mb-0" id="phone">(097) 234-5678</p>
                                    <i class="bi bi-pencil ms-2" onclick="openEdit('phone')"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Edit</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" class="form-control" id="editInput" placeholder="Enter new value" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitEdit()">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>

    <script>
        let editField = '';

        // Function to open the modal for editing
        function openEdit(field) {
            editField = field;
            const value = document.getElementById(field).innerText;
            document.getElementById('editInput').value = value;
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }

        async function submitEdit() {
    const newValue = document.getElementById('editInput').value.trim();
    console.log(newValue);
    if (!newValue) {
        alert('Please enter a valid value.');
        return;
    }

    document.getElementById(editField).innerText = newValue;

    // Save data to the backend
    try {
        const response = await fetch('http://localhost:3000/api/auth/update-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
            body: JSON.stringify({ field: editField, value: newValue }), // Modified this line
        });

        if (!response.ok) {
            throw new Error('Failed to update');
        }

        // Optionally, show a success message
        alert('Profile updated successfully.');
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Error updating profile. Please try again later.');
    }
}

        async function validateToken() {
            const token = localStorage.getItem('token');

            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/auth/validate-profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`,
                    },
                });

                if (!response.ok) {
                    throw new Error('Token validation failed');
                }

                const data = await response.json();
                if (!data.valid) {
                    window.location.href = 'login.html';
                } else {
                    populateProfileForm(data.data); // Populate form with user data
                }
            } catch (error) {
                console.error('Error validating token:', error);
                window.location.href = 'login.html';
            }
        }

        // Function to populate the profile form with user data
        function populateProfileForm(data) {
            document.getElementById('name').innerText = data.name;
            document.getElementById('email').innerText = data.email;
            document.getElementById('phone').innerText = data.phone;
        }
    </script>
</body>
</html>
