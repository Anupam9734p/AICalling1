<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Mazer Admin Dashboard</title>

    <link rel="stylesheet" href="assets/css/bootstrap.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/vendors/iconly/bold.css" />
    <link
      rel="stylesheet"
      href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css"
    />
    <link
      rel="stylesheet"
      href="assets/vendors/bootstrap-icons/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="assets/css/app.css" />
    <link
      rel="shortcut icon"
      href="assets/images/favicon.svg"
      type="image/x-icon"
    />
  </head>
  <body style="background-color: #eee" onload="validateToken()">
    <section style="background-color: #f7f7f7">
      <div class="container py-5">
        <div class="row justify-content-center mb-4">
          <div class="col-lg-8">
            <nav
              aria-label="breadcrumb"
              class="bg-white shadow-sm rounded-3 p-3"
            >
              <ol class="breadcrumb mb-0 justify-content-center">
                <li
                  class="breadcrumb-item active text-center"
                  aria-current="page"
                >
                  <h4 class="mb-0">Profile</h4>
                </li>
              </ol>
            </nav>
          </div>
        </div>

        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="card mb-4 shadow-sm border-0">
              <div class="card-body text-center">
                <img
                  src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3.webp"
                  alt="avatar"
                  class="rounded-circle img-fluid mb-3"
                  style="
                    width: 150px;
                    border: 5px solid #fff;
                    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
                  "
                />
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card mb-4 shadow-sm border-0">
              <div class="card-body p-4">
                <!-- Full Name -->
                <div class="row mb-3">
                  <div class="col-sm-3">
                    <p class="mb-0 text-muted">Full Name</p>
                  </div>
                  <div class="col-sm-9 d-flex align-items-center">
                    <p
                      class="text-dark mb-0"
                      id="name"
                      onclick="openEdit('name')"
                    >
                      Johnatan Smith
                    </p>
                    <i
                      class="bi bi-pencil ms-2 text-muted"
                      onclick="openEdit('name')"
                      style="cursor: pointer"
                    ></i>
                  </div>
                </div>
                <hr />

                <!-- Email -->
                <div class="row mb-3">
                  <div class="col-sm-3">
                    <p class="mb-0 text-muted">Email</p>
                  </div>
                  <div class="col-sm-9 d-flex align-items-center">
                    <p class="text-dark mb-0" id="email">example@example.com</p>
                    <i
                      class="bi bi-pencil ms-2 text-muted"
                      onclick="openEdit('email')"
                      style="cursor: pointer"
                    ></i>
                  </div>
                </div>
                <hr />

                <!-- Phone -->
                <div class="row mb-3">
                  <div class="col-sm-3">
                    <p class="mb-0 text-muted">Phone</p>
                  </div>
                  <div class="col-sm-9 d-flex align-items-center">
                    <p class="text-dark mb-0" id="phone">(097) 234-5678</p>
                    <i
                      class="bi bi-pencil ms-2 text-muted"
                      onclick="openEdit('phone')"
                      style="cursor: pointer"
                    ></i>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-sm-3">
                    <p class="mb-0 text-muted">Credit Usage</p>
                  </div>
                  <div class="col-sm-9 d-flex align-items-center">
                    <p class="text-dark mb-0" id="credit">0</p>
                  </div>
                </div>
                <hr />

                <div
                  class="row mb-3"
                  id="userListSection"
                  style="display: block"
                >
                  <div class="col-sm-3">
                    <p class="mb-0 text-muted">All Users</p>
                  </div>
                  <div class="col-sm-9">
                    <ul id="userList" class="list-group">
                      <p class="text-dark mb-0" id="phone">No Data Found</p>
                    </ul>
                  </div>
                </div>
                <hr />

                <!-- Go to Dashboard Button -->
                <div class="text-center">
                  <a
                    href="index.html"
                    class="btn btn-primary mt-3"
                    style="padding: 10px 30px; font-size: 1rem"
                    >Go to Dashboard</a
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Modal -->
      <div
        class="modal fade"
        id="editModal"
        tabindex="-1"
        aria-labelledby="editModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Edit</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <input
                type="text"
                class="form-control"
                id="editInput"
                placeholder="Enter new value"
              />
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="submitEdit()"
              >
                Save changes
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>

    <script>
      let editField = "";

      // Function to open the modal for editing
      function openEdit(field) {
        editField = field;
        const value = document.getElementById(field).innerText;
        document.getElementById("editInput").value = value;
        const editModal = new bootstrap.Modal(
          document.getElementById("editModal")
        );
        editModal.show();
      }

      async function submitEdit() {
        const newValue = document.getElementById("editInput").value.trim();
        console.log(newValue);
        if (!newValue) {
          alert("Please enter a valid value.");
          return;
        }

        document.getElementById(editField).innerText = newValue;

        // Save data to the backend
        try {
          const response = await fetch(
          //  "http://localhost:3000/api/auth/update-profile",
             "https://aicalling-demo.onrender.com/api/auth/update-profile",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({ field: editField, value: newValue }), // Modified this line
            }
          );

          if (!response.ok) {
            throw new Error("Failed to update");
          }

          console.log(response);
          // Optionally, show a success message
          alert("Profile updated successfully.");
        } catch (error) {
          console.error("Error updating profile:", error);
          alert("Error updating profile. Please try again later.");
        }
      }

      async function validateToken() {
        const token = localStorage.getItem("token");

        if (!token) {
          window.location.href = "login.html";
          return;
        }

        try {
          const response = await fetch(
          //  "http://localhost:3000/api/auth/validate-profile",
             "https://aicalling-demo.onrender.com/api/auth/validate-profile",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Token validation failed");
          }

          const data = await response.json();
          console.log(data);
          if (!data.valid) {
            window.location.href = "login.html";
          } else {
            populateProfileForm(data.data);
            if (data.data.role === "admin") {
              document.getElementById("userListSection").style.display =
                "block";
              fetchAllUsers(token);
            } // Populate form with user data
            if (data.data.role === "super_admin") {
              document.getElementById("userListSection").style.display =
                "block";
              fetchAllAdmins(token);
            }
          }
        } catch (error) {
          console.error("Error validating token:", error);
          window.location.href = "login.html";
        }
      }

      // Function to populate the profile form with user data
      function populateProfileForm(data) {
        console.log(data);
        document.getElementById("name").innerText = data.name;
        document.getElementById("email").innerText = data.email;
        document.getElementById("phone").innerText = data.phone;
        if (data.credit >=0) {
          document.getElementById("credit").innerText = data.credit;
        } else if (data.credits >=0) {
          document.getElementById("credit").innerText = data.credits;
        } else {
          document.getElementById("credit").innerText = "Admin";
        }
      }

      async function fetchAllUsers(token) {
        try {
         // const response = await fetch("http://localhost:3000/api/auth/users", {
             const response = await fetch("https://aicalling-demo.onrender.com/api/auth/users", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Failed to fetch users");
          }

          const data = await response.json();
          console.log("All users with sub-users:", data);

          const userList = document.getElementById("userList");
          userList.innerHTML = ""; // Clear the list first

          // Check if subUsers exist in the response
          if (data.subUsers && data.subUsers.length > 0) {
            data.subUsers.map((subUser) => {
              const listItem = document.createElement("li");
              listItem.classList.add("list-group-item");

              // Check and display user details or "No data found"
              const name = subUser.name || "No name found";
              const email = subUser.email || "No email found";
              const phone = subUser.phone || "No phone found";
              const credit = subUser.credit;

              // Add the user details to the list item
              listItem.innerHTML = `
                          <strong>Name:</strong> ${name} <br/>
                          <strong>Email:</strong> ${email} <br/>
                          <strong>Phone:</strong> ${phone}<br/>
                          <strong>Credit Usage:</strong> ${credit}<br/>
                      `;

              userList.appendChild(listItem);
            });
          } else {
            // If no subUsers found, show a message
            const listItem = document.createElement("li");
            listItem.classList.add("list-group-item");
            listItem.textContent = "No sub-users found";
            userList.appendChild(listItem);
          }
        } catch (error) {
          console.error("Error fetching users:", error);
        }
      }

      async function fetchAllAdmins(token) {
        try {
          const response = await fetch(
            //"http://localhost:3000/api/auth/admins",
            "https://aicalling-demo.onrender.com/api/auth/admins",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok) {
            if (response.status === 401) {
              alert("Session expired. Please log in again.");
              window.location.href = "/login";
              return;
            }
            throw new Error("Failed to fetch admins");
          }

          const data = await response.json();
          console.log("All admin users with sub-users:", data);

          const userList = document.getElementById("userList");
          if (!userList) {
            console.error("User list element not found");
            return;
          }

          userList.innerHTML = "";

          if (data.admins && data.admins.length > 0) {
            console.log("Come");
            data.admins.forEach((admin) => {
              console.log("Comedffd");
              if (admin.role === "admin") {
                const listItem = document.createElement("li");
                listItem.classList.add("list-group-item");

                const name = admin.name || "No name found";
                const email = admin.email || "No email found";
                const phone = admin.phone || "No phone found";
                const credit = admin.credits || "No credit available";
                const subUserCount = admin.subUsers ? admin.subUsers.length : 0;

                console.log(name);
                console.log(email);
                listItem.innerHTML = `
                  <strong>Name:</strong> ${name} <br/>
                  <strong>Email:</strong> ${email} <br/>
                  <strong>Phone:</strong> ${phone}<br/>
                  <strong>Credit:</strong> ${credit}<br/>
                  <strong>Sub-Users:</strong> ${subUserCount}
                `;

                userList.appendChild(listItem);
              }
            });
          } else {
            const listItem = document.createElement("li");
            listItem.classList.add("list-group-item");
            listItem.textContent = "No admin users found";
            userList.appendChild(listItem);
          }
        } catch (error) {
          console.error("Error fetching admins:", error);
          alert(
            "An error occurred while fetching admin data. Please try again later."
          );
        }
      }
    </script>
  </body>
</html>
