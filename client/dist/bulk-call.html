<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Layout - Mazer Admin Dashboard</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/bootstrap.css" />

    <link
      rel="stylesheet"
      href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css"
    />
    <link
      rel="stylesheet"
      href="assets/vendors/bootstrap-icons/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="assets/css/app.css" />
    <link
      rel="shortcut icon"
      href="assets/images/favicon.svg"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        width: 100%;
      }
      .profile-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
      }

      .burger-btn {
        display: flex;
        align-items: center;
      }

      .dropdown-menu {
        min-width: 150px;
        text-align: center;
      }
      .dropdown-item {
        display: flex;
        align-items: center;
      }

      .dropdown-item i {
        margin-right: 8px; /* Adds space between the icon and text */
      }

      .dropdown-divider {
        border: none;
        height: 0.5px;
        background-color: #e9ecef;
        margin: 0.5rem 0;
        width: calc(100% - 1rem);
        margin-left: auto;
        margin-right: auto;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div id="sidebar" class="active">
        <div class="sidebar-wrapper active">
          <div class="sidebar-header">
            <div class="d-flex justify-content-between">
              <div class="logo">
                <a href="index.html"
                  ><img src="assets/images/logo/logo.png" alt="Logo" srcset=""
                /></a>
              </div>
              <div class="toggler">
                <a href="#" class="sidebar-hide d-xl-none d-block"
                  ><i class="bi bi-x bi-middle"></i
                ></a>
              </div>
            </div>
          </div>
          <div class="sidebar-menu">
            <ul class="menu">
              <li class="sidebar-title">Menu</li>

              <li class="sidebar-item">
                <a href="index.html" class="sidebar-link">
                  <i class="bi bi-grid-fill"></i>
                  <span>Dashboard</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a href="single-call.html" class="sidebar-link">
                  <i class="bi bi-file-earmark-medical-fill"></i>
                  <span>Single Call</span>
                </a>
              </li>
              <li class="sidebar-item active">
                <a href="bulk-call.html" class="sidebar-link">
                  <i class="bi bi-stack"></i>
                  <span>Bulk Call</span>
                </a>
              </li>

              <li class="sidebar-item">
                <a href="call-logs.html" class="sidebar-link">
                  <i class="bi bi-journal-text"></i>
                  <span>Call Logs</span>
                </a>
              </li>

              <li class="sidebar-item">
                <a href="sms-email.html" class="sidebar-link">
                  <i class="bi bi-envelope-fill"></i>
                  <span>SMS & Email</span>
                </a>
              </li>

              <li class="sidebar-item">
                <a href="appointment.html" class="sidebar-link">
                  <i class="bi bi-calendar-check-fill"></i>
                  <span>Appointment</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="main">
        <header
          class="dashboard-header d-flex align-items-center justify-content-between px-3 py-2"
        >
          <a href="#" class="burger-btn d-block d-xl-none">
            <i class="bi bi-justify fs-3"></i>
          </a>

          <!-- Profile Image and Dropdown Container -->
          <div class="dropdown d-flex ms-auto">
            <img
              src="./assets/images/faces/profile-pic.jpg"
              alt="Profile"
              class="profile-img dropdown-toggle"
              id="profileDropdown"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            />
            <ul
              class="dropdown-menu dropdown-menu-end"
              aria-labelledby="profileDropdown"
              id="dropdownMenu"
            >
              <li>
                <a class="dropdown-item" href="profile.html">
                  <i class="fa-solid fa-user"></i> Profile
                </a>
              </li>
              <li></li>
              <li>
                <a class="dropdown-item" href="#" id="logout-btn">
                  <i class="fa-solid fa-right-from-bracket"></i> Log Out
                </a>
              </li>
            </ul>
          </div>
        </header>

        <div class="page-heading">
          <div class="page-title">
            <div class="row">
              <div class="col-12 col-md-6 order-md-1 order-last">
                <h3>Make Bulk Call</h3>
              </div>
              <div class="col-12 col-md-6 order-md-2 order-first">
                <nav
                  aria-label="breadcrumb"
                  class="breadcrumb-header float-start float-lg-end"
                >
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                      <a href="index.html">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                      Bulk Call
                    </li>
                  </ol>
                </nav>
              </div>
            </div>
          </div>

          <!-- Basic Horizontal form layout section start -->
          <!-- Bulk Call Form -->
          <section id="bulk-horizontal-layouts" class="container mt-5">
            <div class="row justify-content-center">
              <div class="col-md-15">
                <div class="card">
                  <div class="card-content">
                    <div class="card-body">
                      <form class="form form-horizontal" id="bulk-call-form">
                        <div class="form-body">
                          <div class="row">
                            <div class="col-md-4">
                              <label>CSV File Upload</label>
                            </div>
                            <div class="col-md-8 form-group">
                              <input
                                type="file"
                                id="file-upload"
                                class="form-control"
                                name="file"
                                accept=".xlsx"
                              />
                            </div>
                            <div class="col-md-4">
                              <label>Prompt</label>
                            </div>
                            <div class="col-md-8 form-group">
                              <textarea
                                class="form-control"
                                id="prompt"
                                rows="3"
                              ></textarea>
                            </div>
                            <div class="col-md-4">
                              <label>Select Language</label>
                            </div>
                            <div class="col-md-8 form-group">
                              <select class="form-control" id="language">
                                <option value="">Select Language</option>
                                <option value="bg">Bulgarian</option>
                                <option value="ca">Catalan</option>
                                <option value="cs">Czech</option>
                                <option value="da">Danish</option>
                                <option value="da-DK">Danish (Denmark)</option>
                                <option value="de">German</option>
                                <option value="de-CH">
                                  German (Switzerland)
                                </option>
                                <option value="el">Greek</option>
                                <option value="en">English</option>
                                <option value="en-AU">
                                  English (Australia)
                                </option>
                                <option value="en-GB">English (UK)</option>
                                <option value="en-IN">English (India)</option>
                                <option value="en-NZ">
                                  English (New Zealand)
                                </option>
                                <option value="en-US">English (US)</option>
                                <option value="es">Spanish</option>
                                <option value="es-419">
                                  Spanish (Latin America)
                                </option>
                                <option value="es-LATAM">
                                  Spanish (LATAM)
                                </option>
                                <option value="et">Estonian</option>
                                <option value="fi">Finnish</option>
                                <option value="fr">French</option>
                                <option value="fr-CA">French (Canada)</option>
                                <option value="hi">Hindi</option>
                                <option value="hi-Latn">Hindi (Latin)</option>
                                <option value="hu">Hungarian</option>
                                <option value="id">Indonesian</option>
                                <option value="it">Italian</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="ko-KR">
                                  Korean (South Korea)
                                </option>
                                <option value="lt">Lithuanian</option>
                                <option value="lv">Latvian</option>
                                <option value="ms">Malay</option>
                                <option value="multi">
                                  Multiple Languages
                                </option>
                                <option value="nl">Dutch</option>
                                <option value="nl-BE">Dutch (Belgium)</option>
                                <option value="no">Norwegian</option>
                                <option value="pl">Polish</option>
                                <option value="pt">Portuguese</option>
                                <option value="pt-BR">
                                  Portuguese (Brazil)
                                </option>
                                <option value="ro">Romanian</option>
                                <option value="ru">Russian</option>
                                <option value="sk">Slovak</option>
                                <option value="sv">Swedish</option>
                                <option value="sv-SE">Swedish (Sweden)</option>
                                <option value="ta">Tamil</option>
                                <option value="taq">Tamasheq</option>
                                <option value="th">Thai</option>
                                <option value="th-TH">Thai (Thailand)</option>
                                <option value="tr">Turkish</option>
                                <option value="uk">Ukrainian</option>
                                <option value="vi">Vietnamese</option>
                                <option value="zh">Chinese</option>
                                <option value="zh-CN">
                                  Chinese (Simplified)
                                </option>
                                <option value="zh-Hans">
                                  Chinese (Simplified Han)
                                </option>
                                <option value="zh-Hant">
                                  Chinese (Traditional Han)
                                </option>
                                <option value="zh-TW">Chinese (Taiwan)</option>
                              </select>
                            </div>
                            <div
                              class="col-sm-12 d-flex justify-content-end mt-3"
                            >
                              <button
                                type="button"
                                onclick="processBulkCalls()"
                                class="btn btn-primary me-1 mb-1"
                              >
                                Submit
                              </button>
                              <button
                                type="reset"
                                class="btn btn-light-secondary me-1 mb-1"
                              >
                                Reset
                              </button>
                            </div>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <div id="call-results"></div>
                <!-- Display call results here -->
              </div>
            </div>
          </section>
          <!-- // Basic Horizontal form layout section end -->
        </div>
      </div>
    </div>
    <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="assets/js/main.js"></script>

    <!-- Ensure JavaScript containing processBulkCalls function loads properly -->
    <script>
      const logoutBtn = document.getElementById("logout-btn");

      logoutBtn.addEventListener("click", () => {
        // Remove the JWT token from localStorage
        console.log("click");
        localStorage.removeItem("token");

        // Redirect the user to the login page

        window.location.href = "login.html";
      });

      async function validateToken() {
        const token = localStorage.getItem("token");

        if (!token) {
          // If no token, redirect to login page
          window.location.href = "login.html";
          return;
        }

        try {
          const response = await fetch(
            // "https://aicalling-osdb.onrender.com/api/auth/validate",
             "https://aicalling-demo.onrender.com/api/auth/validate",
          //  "http://localhost:3000/api/auth/validate",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Token validation failed");
          }

          const data = await response.json();
          if (!data.valid) {
            // If token is not valid, redirect to login page
            window.location.href = "login.html";
          }
          const role = data.role;

          //console.log(role);
          if (role === "admin" || role === "subuser") {
            const dropdownMenu = document.getElementById("dropdownMenu");

            const adminItems = `
 
     <li>
        <a class="dropdown-item" href="bulk-call-email.html">
          <i class="fa-solid fa-envelope"></i> Send Bulk Email
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="bulk-sms.html">
          <i class="fa-solid fa-comments"></i> Send Bulk SMS
        </a>
      </li>
      <li>

      </li>
    `;

            // Insert admin items before the logout button
            dropdownMenu.insertAdjacentHTML("beforeend", adminItems);
          }

          if (role === "admin") {
            const dropdownMenu = document.getElementById("dropdownMenu");

            const adminItems = `
       <li>
        <a class="dropdown-item" href="add-member.html">
          <i class="fa-solid fa-comments"></i> Add Member
        </a>
      <li>

      </li>
    `;

            // Insert admin items before the logout button
            dropdownMenu.insertAdjacentHTML("beforeend", adminItems);
          }

          if (role === "admin" || role === "user") {
            const dropdownMenu = document.getElementById("dropdownMenu");

            const adminItems = `
<li>
<a class="dropdown-item" href="buy-membership.html">
<i class="fa-solid fa-credit-card"></i> Buy Membership
</a>
</li>
<li>
<hr
style="
border: none;
height: 0.5px;
background-color: #e9ecef;
margin: 0.5rem 0;
width: calc(100% - 1rem);
margin-left: auto;
margin-right: auto;
"
/>
</li>
`;

            // Insert admin items before the logout button
            dropdownMenu.insertAdjacentHTML("beforeend", adminItems);
          }
        } catch (error) {
          console.error("Error validating token:", error);
          // Redirect to login if there's an error
          window.location.href = "login.html";
        }
      }

      // Call the validateToken function when the page loads
      window.onload = validateToken;

      function processBulkCalls() {
        const fileInput = document.getElementById("file-upload");
        const promptText = document.getElementById("prompt").value;

        if (fileInput.files.length === 0) {
          alert("Please upload a CSV or Excel file.");
          return;
        }

        const file = fileInput.files[0];
        const fileName = file.name.toLowerCase();

        if (fileName.endsWith(".csv")) {
          // Handle CSV file
          const reader = new FileReader();
          reader.onload = function (e) {
            const text = e.target.result;
            const data = csvToArray(text);
            initiateCalls(data, promptText);
          };
          reader.readAsText(file);
        } else if (fileName.endsWith(".xlsx")) {
          // Handle Excel (.xlsx) file
          const reader = new FileReader();
          reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheetName = workbook.SheetNames[0]; // Get the first sheet
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet); // Convert sheet to JSON
            initiateCalls(json, promptText);
          };
          reader.readAsArrayBuffer(file);
        } else {
          alert("Unsupported file format. Please upload a CSV or Excel file.");
        }
      }

      function csvToArray(str, delimiter = ",") {
        const headers = str.slice(0, str.indexOf("\n")).split(delimiter);
        const rows = str.slice(str.indexOf("\n") + 1).split("\n");
        return rows.map(function (row) {
          const values = row.split(delimiter);
          const el = headers.reduce(function (object, header, index) {
            object[header] = values[index];
            return object;
          }, {});
          return el;
        });
      }

      function initiateCalls(users, prompt) {
        users.forEach((user) => {
          console.log(JSON.stringify(user) + "hello user");
          if (!user || Object.keys(user).length === 0) {
            console.log(`Skipping empty or undefined row at index ${index}`);
            return; // Skip this row if it's empty or undefined
          }

          const nameKey = Object.keys(user).find(
            (key) => key.trim().toLowerCase() === "name"
          );
          const phoneNumberKey = Object.keys(user).find(
            (key) => key.trim().toLowerCase() === "phone number"
          );

          const name = user[nameKey];
          const phoneNumber = user[phoneNumberKey];
          const formattedPhoneNumber = `+${phoneNumber.replace(/[^\d]/g, "")}`;
          const selectedLanguage = document.getElementById("language").value;
          if (selectedLanguage == "") {
            Swal.fire({
              icon: "error",
              text: "Please select a language First",
            });
            return;
          }
          const callOptions = {
            method: "POST",
            headers: {
              Authorization: "22576079-730d-4707-b8ab-f780113249f3",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: `Bulk call to ${name}`,
              // phoneNumberId: "d51cf9b6-a9de-4e9d-acf7-734ea03a8eac",
              phoneNumberId: "bd57afc5-2af2-492e-88d1-856dea3320ef",
              customer: {
                number: formattedPhoneNumber,
              },
              assistant: {
                transcriber: {
                  provider: "deepgram",
                  model: "nova-2",
                  language: "en-AU",
                  smartFormat: false,
                },
                model: {
                  provider: "openai",
                  model: "gpt-4",
                  messages: [
                    {
                      role: "system",
                      content: prompt,
                    },
                  ],
                },
              },
            }),
          };

          fetch("https://api.vapi.ai/call", callOptions)
            .then((response) => response.json())
            .then((data) => {
              console.log(`Call to ${name} initiated:`, data);
              const callSid = data.id; // Assuming 'id' is the unique identifier for the call
              updateCallResults(
                name,
                formattedPhoneNumber,
                "Call initiated successfully"
              );
              // Start polling for call status
              pollCallStatus(callSid, name, formattedPhoneNumber);
            })
            .catch((error) => {
              console.error("Error initiating call to", name, ":", error);
              updateCallResults(
                name,
                formattedPhoneNumber,
                "Failed to initiate call"
              );
            });
        });
      }
      function pollCallStatus(callSid, name, phoneNumber) {
        const pollInterval = 30000; // 30 seconds
        const maxRetries = 20; // Maximum number of retries

        function checkStatus(retries) {
          fetch(`https://api.vapi.ai/call/${callSid}`, {
            method: "GET",
            headers: {
              Authorization: "Bearer 22576079-730d-4707-b8ab-f780113249f3",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              console.log(`Status for call ${callSid}:`, data);
              const status = data.status; // Call status
              const endedReason = data.endedReason; // Reason why call ended

              if (status === "ended") {
                // Send SMS only if call has ended
                sendSMS(name, phoneNumber, endedReason);
                scheduleAppointment();
                // sendEmail("madhavbansal356@gmail.com", "Testing", "Hi, This mail is for testing purpose")
              } else if (retries < maxRetries) {
                setTimeout(() => checkStatus(retries + 1), pollInterval);
              } else {
                console.log(`Call ${callSid} did not complete in time.`);
              }
            })
            .catch((error) => {
              console.error("Error checking call status:", error);
              if (retries < maxRetries) {
                setTimeout(() => checkStatus(retries + 1), pollInterval);
              }
            });
        }

        checkStatus(0);
      }

      function sendSMS(name, phoneNumber, endedReason) {
        const message = `Hello ${name}, Thank you for your time. We will schedule a meeting with you and provide you with an update soon. Reason for ending: ${
          endedReason || "Not provided"
        }.`;

        //  fetch("https://aicalling-osdb.onrender.com/api/messages/send-sms", {
      //  fetch("http://localhost:3000/api/messages/send-sms", {
        fetch("https://aicalling-demo.onrender.com/api/messages/send-sms", {
          // Adjusted the endpoint to match the route path
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            toNumber: phoneNumber,
            message: message,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Failed to send SMS: ${response.statusText}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("SMS sent successfully:", data);
          })
          .catch((error) => {
            console.error("Error sending SMS:", error.message);
          });
      }

      function updateCallResults(name, phoneNumber, status) {
        const resultsDiv = document.getElementById("call-results");
        const result = document.createElement("div");
        result.innerHTML = `Call to ${name} (${phoneNumber}): ${status}`;
        resultsDiv.appendChild(result);
      }

      async function getTranscript() {
        try {
          const response = await fetch("https://api.vapi.ai/call", options);
          const data = await response.json();

          if (data.length > 0) {
            // Find the call with the most recent 'updatedAt' timestamp
            const latestCall = data.reduce((latest, call) => {
              return new Date(call.updatedAt) > new Date(latest.updatedAt)
                ? call
                : latest;
            });

            const latestTranscript = latestCall.transcript;

            // Print the latest transcript
            console.log("Transcript:", latestTranscript);

            return latestTranscript;
          } else {
            console.log("No transcripts available.");
            return null;
          }
        } catch (err) {
          console.error(err);
          return null;
        }
      }

      async function scheduleAppointment() {
        const demoTranscript = await getTranscript(); // Wait for the transcript to be fetched

        if (!demoTranscript) {
          console.error("Failed to retrieve transcript.");
          return;
        }

        console.log("Latest Transcript:", demoTranscript);

        // First, make a POST request to the `/api/demo-transcript` endpoint
        //fetch('https://aicalling-osdb.onrender.com/api/demo-transcript', {
      //  fetch("http://localhost:3000/api/demo-transcript", {
        fetch("https://aicalling-demo.onrender.com/api/demo-transcript", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ transcript: demoTranscript }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Network response was not ok " + response.statusText
              );
            }
            return response.json();
          })
          .then((data) => {
            console.log("Success:", data);

            // Extract variables from the response
            const { name, email, phone, date, time } = data;

            // Log extracted fields to check if they are correct
            console.log("Extracted Info:", { name, email, phone, date, time });

            // Convert the date and time into ISO format
            let appointmentDateTime;
            try {
              // Check if date and time are valid
              if (date && time) {
                // Convert date format if necessary
                const formattedDate = date.replace(
                  /(\d{4})\/(\d{2})\/(\d{2})/,
                  "$1-$2-$3"
                );
                appointmentDateTime = new Date(`${formattedDate}T${time}:00`);

                // Check if the date is valid
                if (isNaN(appointmentDateTime.getTime())) {
                  throw new Error("Invalid date/time value");
                }
              } else {
                throw new Error("Date or time missing");
              }
            } catch (error) {
              console.error("Error with date/time conversion:", error);
              Swal.fire({
                icon: "error",
                title: "Invalid Date/Time",
                text: "The provided date or time is invalid. Please check the format.",
              });
              return;
            }

            // Prepare event data using the extracted information
            const eventData = {
              summary: `Meeting with ${name}`,
              location: "123 Main St, Anytown, USA",
              description: `Appointment with ${name}. Contact: ${phone}. Email: ${email}`,
              startDateTime: appointmentDateTime.toISOString(),
              endDateTime: new Date(
                appointmentDateTime.getTime() + 60 * 60 * 1000
              ).toISOString(), // 1 hour duration
            };

            // Send event data to your event scheduling endpoint
            // return fetch("https://aicalling-osdb.onrender.com/calendar/events", {
         //   return fetch("http://localhost:3000/calendar/event", {
            return fetch("https://aicalling-demo.onrender.com/calendar/event", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(eventData),
            });
          })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Network response was not ok " + response.statusText
              );
            }
            return response.json();
          })
          .then((data) => {
            console.log("Event created successfully:", data);
            Swal.fire({
              icon: "success",
              title: "Appointment Scheduled",
              text: "The appointment was scheduled successfully.",
            });
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
            Swal.fire({
              icon: "error",
              title: "Failed to Schedule Appointment",
              text: "An error occurred while scheduling the appointment. Please try again.",
            });
          });
      }
    </script>
  </body>
</html>
